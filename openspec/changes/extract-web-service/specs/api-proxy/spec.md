# API 反代服务规范

## 新增需求

### 需求：OpenAI 协议支持
系统必须实现 OpenAI API 协议的兼容接口，支持 `/v1/chat/completions`、`/v1/completions`、`/v1/images/generations` 等端点。

#### 场景：聊天补全请求
- **当** 客户端发送 `POST /v1/chat/completions` 请求
- **那么** 应将请求映射到上游 Gemini/Claude API
- **并且** 应将上游响应转换为 OpenAI 格式返回

#### 场景：图像生成请求
- **当** 客户端发送 `POST /v1/images/generations` 请求
- **那么** 应调用 Imagen 3 API 生成图像
- **并且** 应返回 OpenAI 格式的图像响应

#### 场景：模型列表查询
- **当** 客户端发送 `GET /v1/models` 请求
- **那么** 应返回支持的模型列表（包括映射后的虚拟模型）
- **并且** 应包含模型 ID 和类型信息

### 需求：Anthropic 协议支持
系统必须实现 Anthropic Claude API 协议的兼容接口，支持 `/v1/messages` 端点。

#### 场景：消息请求
- **当** 客户端发送 `POST /v1/messages` 请求
- **那么** 应将请求映射到上游 Gemini API
- **并且** 应保留 Anthropic 特有的字段（如 thinking、tools）

#### 场景：流式响应
- **当** 请求包含 `stream: true` 参数
- **那么** 应使用 Server-Sent Events (SSE) 返回流式响应
- **并且** 应正确处理 `content-block-delta` 和 `message-delta` 事件

### 需求：Gemini 协议支持
系统必须实现 Google Gemini API 原生协议的透传支持。

#### 场景：原生 Gemini 请求
- **当** 客户端发送 Gemini 原生格式请求
- **那么** 应直接透传到上游 Gemini API
- **并且** 应保持请求和响应的原始格式

### 需求：协议转换与映射
系统必须在不同协议之间进行智能转换，包括请求体、响应体和错误格式。

#### 场景：OpenAI 到 Gemini 转换
- **当** 接收 OpenAI 格式的聊天请求
- **那么** 应转换消息格式（role/content）和参数（temperature、max_tokens）
- **并且** 应处理工具调用（function_call）的格式差异

#### 场景：响应格式转换
- **当** 上游返回 Gemini 格式响应
- **那么** 应转换为目标协议的响应格式
- **并且** 应保留流式输出的时间戳和 finish_reason

### 需求：模型路由与映射
系统必须支持自定义模型映射规则，将请求的模型 ID 转换为实际的上游模型。

#### 场景：模型 ID 映射
- **当** 请求的模型 ID 在映射表中存在
- **那么** 应使用映射后的上游模型 ID 发起请求
- **并且** 应在日志中记录映射关系

#### 场景：虚拟模型支持
- **当** 请求的模型 ID 包含后缀（如 `-4k`、`-21x9`）
- **那么** 应解析后缀并调整请求参数（分辨率、比例等）
- **并且** 应保持对客户端的透明性

### 需求：智能账号轮换
系统必须实现账号池的智能轮换策略，包括轮询、权重和故障转移。

#### 场景：轮询调度
- **当** 启用轮询模式且收到新请求
- **那么** 应按顺序选择下一个可用账号
- **并且** 应跳过禁用、限流或配额耗尽的账号

#### 场景：故障转移
- **当** 当前账号返回 429、401 或 5xx 错误
- **那么** 应自动切换到下一个可用账号并重试
- **并且** 应记录故障账号以供后续分析

#### 场景：会话粘性
- **当** 同一会话的多个请求在时间窗口内（60秒）
- **那么** 应优先使用同一账号以保持上下文
- **并且** 应在日志中标记会话 ID

### 需求：配额保护与降级
系统必须监控账号配额使用情况，实现智能降级策略。

#### 场景：后台任务识别
- **当** 请求特征匹配后台任务（如标题生成、摘要）
- **那么** 应自动降级到 Flash/Lite 等低成本模型
- **并且** 应在日志中标记为后台任务

#### 场景：配额耗尽处理
- **当** 账号配额低于阈值或已耗尽
- **那么** 应暂停使用该账号并切换到备用账号
- **并且** 应在 UI 中显示配额状态

### 需求：错误重试与退避
系统必须实现智能的错误重试机制，根据错误类型采用不同的退避策略。

#### 场景：429 限流重试
- **当** 收到 429 Too Many Requests 错误
- **那么** 应解析 `Retry-After` 头并等待指定时间后重试
- **并且** 若未提供 `Retry-After`，应使用线性退避（1s/2s/3s）

#### 场景：5xx 服务器错误
- **当** 收到 5xx 服务器错误
- **那么** 应使用指数退避策略（1s/2s/4s/8s）
- **并且** 最多重试 3 次后返回错误

#### 场景：400 错误处理
- **当** 收到 400 Bad Request 错误
- **那么** 应分析错误原因（如参数错误、格式不正确）
- **并且** 对于特定错误（如 thinking 签名失败）应重试一次

### 需求：请求监控与日志
系统必须记录所有反代请求的详细信息，用于监控和调试。

#### 场景：请求日志记录
- **当** 收到反代请求
- **那么** 应记录请求 ID、时间戳、模型、账号、响应时间等
- **并且** 日志应持久化到数据库供查询

#### 场景：实时监控接口
- **当** 客户端请求 `GET /api/proxy/monitor` 接口
- **那么** 应返回最近的请求列表（支持分页和筛选）
- **并且** 应包含请求状态、耗时、Token 消耗等信息

### 需求：代理服务控制
系统必须提供 API 接口用于启动、停止和配置代理服务。

#### 场景：启动代理
- **当** 客户端发送 `POST /api/proxy/start` 请求
- **那么** 应启动 HTTP 服务器监听配置的端口
- **并且** 应返回服务状态和监听地址

#### 场景：停止代理
- **当** 客户端发送 `POST /api/proxy/stop` 请求
- **那么** 应优雅关闭 HTTP 服务器
- **并且** 应等待所有进行中的请求完成（最多 30 秒）

#### 场景：获取代理状态
- **当** 客户端发送 `GET /api/proxy/status` 请求
- **那么** 应返回运行状态、端口、活跃连接数等信息

### 需求：代理配置管理
系统必须支持动态配置代理参数，无需重启服务。

#### 场景：更新配置
- **当** 客户端发送 `PUT /api/proxy/config` 请求
- **那么** 应更新代理配置（端口、模型映射、调度模式等）
- **并且** 配置应立即生效

#### 场景：获取配置
- **当** 客户端发送 `GET /api/proxy/config` 请求
- **那么** 应返回当前代理配置
- **并且** 不应包含敏感信息（如 refresh_token）

### 需求：多模态支持
系统必须支持图像输入和输出，包括 Base64 和 URL 格式。

#### 场景：图像识别请求
- **当** 请求包含图像数据（Base64 或 URL）
- **那么** 应正确解析并转换为上游 API 所需格式
- **并且** 应支持最大 100MB 的 Payload

#### 场景：图像生成请求
- **当** 请求要求生成图像
- **那么** 应调用 Imagen 3 API 并返回图像 URL
- **并且** 应支持自定义分辨率和比例参数

### 需求：联网搜索支持
系统必须支持模型的联网搜索能力，并正确返回搜索结果。

#### 场景：触发联网搜索
- **当** 请求的模型支持联网或包含搜索工具调用
- **那么** 应启用 Google Search 并获取搜索结果
- **并且** 应将搜索结果注入到请求上下文中

#### 场景：搜索结果格式化
- **当** 使用 Anthropic 协议
- **那么** 应将搜索结果转换为 `web_search_tool_result` 格式
- **并且** 应包含来源链接和引用信息

### 需求：CORS 支持
系统必须正确处理跨域请求，支持浏览器环境的客户端。

#### 场景：预检请求
- **当** 收到 OPTIONS 预检请求
- **那么** 应返回正确的 CORS 头（Allow-Methods、Allow-Origin 等）
- **并且** 应缓存预检结果（max-age=3600）

#### 场景：跨域实际请求
- **当** 收到跨域的实际请求
- **那么** 应在响应中添加 `Access-Control-Allow-Origin` 头
- **并且** 应根据配置允许或拒绝凭据（credentials）

### 需求：连接池管理
系统必须维护与上游 API 的 HTTP 连接池，优化性能。

#### 场景：连接复用
- **当** 多个请求需要访问同一上游端点
- **那么** 应复用现有连接而非创建新连接
- **并且** 应配置合理的连接池大小和超时时间

#### 场景：连接健康检查
- **当** 连接出现异常或超时
- **那么** 应标记连接为不可用并创建新连接
- **并且** 应定期清理空闲连接

### 需求：上游端点 Fallback
系统必须支持在主端点失败时自动切换到备用端点。

#### 场景：端点切换
- **当** 主端点返回 404、429 或 5xx 错误
- **那么** 应自动切换到备用端点（如 prod → daily）
- **并且** 应在日志中记录切换原因

#### 场景：端点恢复
- **当** 备用端点也失败或主端点恢复
- **那么** 应尝试切换回主端点
- **并且** 应记录端点可用性统计
