# Web 服务规范

## 新增需求

### 需求：独立 Web 服务部署
系统必须提供独立的 Node.js Web 服务，可通过 Docker 容器化部署，与桌面应用完全解耦独立运行。

#### 场景：Docker 部署
- **当** 用户执行 `docker-compose up -d` 命令
- **那么** Web 服务应在容器中启动并监听配置的端口（默认 8080）
- **并且** 数据库文件应挂载到宿主机持久化存储

#### 场景：独立运行
- **当** Web 服务启动时
- **那么** 不应依赖桌面应用的任何进程或组件
- **并且** 应能独立处理所有请求和业务逻辑

### 需求：Web 界面访问
系统必须提供响应式 Web UI，支持通过浏览器访问和管理所有功能。

#### 场景：浏览器访问
- **当** 用户在浏览器中打开 `http://localhost:8046`
- **那么** 应显示登录页面或主界面（根据认证配置）
- **并且** UI 应适配桌面和移动端设备

#### 场景：静态资源托管
- **当** 请求 `/` 或 `/index.html` 路径
- **那么** 应返回构建好的前端静态资源
- **并且** 所有 API 请求应代理到 `/api/*` 路径

### 需求：RESTful API 接口
系统必须提供 RESTful API 接口，供外部应用集成调用。

#### 场景：API 调用
- **当** 客户端发送 HTTP 请求到 `/api/*` 路径
- **那么** 应返回 JSON 格式的响应数据
- **并且** 应包含正确的 HTTP 状态码和 Content-Type 头

#### 场景：错误处理
- **当** API 请求发生错误
- **那么** 应返回统一的错误响应格式 `{ error: string, code: number }`
- **并且** HTTP 状态码应反映错误类型（400/401/404/500 等）

### 需求：配置管理
系统必须支持通过环境变量和配置文件进行配置。

#### 场景：环境变量配置
- **当** 设置环境变量 `PORT`、`DATABASE_PATH` 等
- **那么** 服务启动时应读取并应用这些配置
- **并且** 配置变更应在服务重启后生效

#### 场景：默认配置
- **当** 未提供环境变量时
- **那么** 应使用合理的默认值（如 PORT=8046）
- **并且** 应在日志中记录使用的配置

### 需求：日志记录
系统必须记录关键操作和错误信息，便于问题排查。

#### 场景：请求日志
- **当** 收到 API 请求
- **那么** 应记录请求方法、路径、响应状态和耗时
- **并且** 日志级别应根据环境区分（开发用 DEBUG，生产用 INFO）

#### 场景：错误日志
- **当** 发生未捕获的异常或错误
- **那么** 应记录详细的错误堆栈和上下文信息
- **并且** 不应向客户端暴露敏感的服务器信息

### 需求：健康检查
系统必须提供健康检查端点，用于监控服务状态。

#### 场景：健康检查
- **当** 请求 `GET /health` 端点
- **那么** 应返回服务状态（包括数据库连接状态）
- **并且** 响应时间应小于 100ms

### 需求：数据库兼容性
系统必须使用与桌面应用兼容的 SQLite 数据库结构和格式。

#### 场景：数据库读取
- **当** Web 服务启动并连接到数据库
- **那么** 应能读取桌面应用创建的数据库文件
- **并且** 应正确解析所有表和数据格式

#### 场景：并发访问控制
- **当** 多个进程同时访问数据库
- **那么** 应启用 SQLite WAL 模式
- **并且** 应实现适当的重试机制处理锁定冲突
