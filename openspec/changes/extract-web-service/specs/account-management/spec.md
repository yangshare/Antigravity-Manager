# 账号管理 API 规范

## 新增需求

### 需求：账号列表查询
系统必须提供 API 接口查询所有已添加的账号信息。

#### 场景：获取账号列表
- **当** 客户端发送 `GET /api/accounts` 请求
- **那么** 应返回所有账号的数组，包含 id、email、quota、disabled 等字段
- **并且** 应支持分页参数（page、pageSize）和筛选参数（status、tier）

#### 场景：获取单个账号
- **当** 客户端发送 `GET /api/accounts/:id` 请求
- **那么** 应返回指定账号的完整信息
- **并且** 若账号不存在，应返回 404 状态码

### 需求：账号添加与删除
系统必须支持通过 API 添加新账号和删除现有账号。

#### 场景：添加账号
- **当** 客户端发送 `POST /api/accounts` 请求，包含 email 和 token
- **那么** 应验证 token 有效性并保存到数据库
- **并且** 成功后应返回 201 状态码和创建的账号对象

#### 场景：删除账号
- **当** 客户端发送 `DELETE /api/accounts/:id` 请求
- **那么** 应从数据库中删除该账号
- **并且** 应返回 204 状态码

#### 场景：批量删除
- **当** 客户端发送 `DELETE /api/accounts` 请求，包含账号 ID 数组
- **那么** 应删除所有指定的账号
- **并且** 应返回删除成功的账号数量

### 需求：OAuth 授权流程
系统必须支持 OAuth 2.0 授权流程添加 Google 和 Anthropic 账号。

#### 场景：开始 OAuth 授权
- **当** 客户端发送 `POST /api/accounts/oauth/start` 请求
- **那么** 应生成授权 URL 并返回给客户端
- **并且** 应启动本地回调服务器监听授权完成

#### 场景：完成 OAuth 授权
- **当** 用户在浏览器中完成授权，回调服务器接收到回调
- **那么** 应提取授权码并交换 access_token 和 refresh_token
- **并且** 应保存账号信息并返回创建的账号对象

#### 场景：取消 OAuth 授权
- **当** 客户端发送 `POST /api/accounts/oauth/cancel` 请求
- **那么** 应停止回调服务器并清理临时数据
- **并且** 应返回 200 状态码

### 需求：账号配额查询
系统必须支持查询账号的 API 配额使用情况。

#### 场景：查询单个账号配额
- **当** 客户端发送 `GET /api/accounts/:id/quota` 请求
- **那么** 应返回该账号所有模型的配额信息（百分比、重置时间）
- **并且** 若配额信息过期，应自动从上游 API 刷新

#### 场景：刷新所有配额
- **当** 客户端发送 `POST /api/accounts/refresh` 请求
- **那么** 应异步刷新所有账号的配额信息
- **并且** 应返回刷新任务的状态（成功/失败数量）

### 需求：账号状态管理
系统必须支持禁用和启用账号，以及标记账号状态。

#### 场景：禁用账号
- **当** 客户端发送 `PUT /api/accounts/:id/disable` 请求
- **那么** 应将账号标记为禁用状态，并记录禁用原因和时间
- **并且** 该账号不应再参与 API 反代请求

#### 场景：启用账号
- **当** 客户端发送 `PUT /api/accounts/:id/enable` 请求
- **那么** 应清除账号的禁用状态
- **并且** 该账号应恢复参与 API 反代请求

#### 场景：反代禁用
- **当** 客户端发送 `PUT /api/accounts/:id/proxy-disable` 请求
- **那么** 应将账号标记为"反代已禁用"，但仍可在应用中使用
- **并且** 该账号不应参与 API 反代，但配额查询等功能正常

### 需求：账号导入导出
系统必须支持从其他数据源导入账号信息。

#### 场景：从 V1 版本导入
- **当** 客户端发送 `POST /api/accounts/import/v1` 请求
- **那么** 应尝试读取 V1 版本的数据库并迁移账号信息
- **并且** 应返回成功导入的账号数量

#### 场景：从自定义数据库导入
- **当** 客户端发送 `POST /api/accounts/import/db` 请求，提供数据库路径
- **那么** 应从指定路径的数据库读取并导入账号
- **并且** 应验证数据格式并处理重复账号

### 需求：当前账号切换
系统必须支持切换当前活跃账号，用于桌面应用的 Token 注入。

#### 场景：切换当前账号
- **当** 客户端发送 `POST /api/accounts/:id/switch` 请求
- **那么** 应将指定账号设置为当前活跃账号
- **并且** 应更新账号的 `last_used` 时间戳

#### 场景：获取当前账号
- **当** 客户端发送 `GET /api/accounts/current` 请求
- **那么** 应返回当前活跃账号的信息
- **并且** 若未设置活跃账号，应返回 404 状态码

### 需求：账号排序
系统必须支持自定义账号的显示顺序。

#### 场景：重新排序
- **当** 客户端发送 `PUT /api/accounts/reorder` 请求，提供排序后的 ID 数组
- **那么** 应更新所有账号的排序索引
- **并且** 应返回 200 状态码

### 需求：账号数据验证
系统必须在添加或更新账号时验证数据的有效性。

#### 场景：Token 格式验证
- **当** 提供的 token 格式不正确
- **那么** 应返回 400 状态码和详细的错误信息
- **并且** 不应保存无效的账号数据

#### 场景：邮箱格式验证
- **当** 提供的 email 格式不正确
- **那么** 应返回 400 状态码
- **并且** 应提示正确的邮箱格式要求

### 需求：账号权限控制
系统必须根据用户权限控制账号操作的访问。

#### 场景：未授权访问
- **当** 未认证的用户尝试访问账号 API
- **那么** 应返回 401 状态码
- **并且** 应提供正确的认证方式提示

#### 场景：只读访问
- **当** 用户只有只读权限
- **那么** 应允许查询操作（GET）
- **并且** 应拒绝修改操作（POST/PUT/DELETE），返回 403 状态码
